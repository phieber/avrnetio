<!--

possibilities to implements this:
    * flot - a javascript plotting library <http://code.google.com/p/flot/>
      problem: javascript can't do TCP sockets, so no realtime (but with HTTP we can do it)

    * any javascript library, data via sockets using one of <>
      
    * python applet using jython <http://www.jython.org/archive/21/applets/index.html>
      problem: in newer versions of jython (>2.1) applets are not mentioned anymore
      more doc: http://oreilly.com/catalog/python2/chapter/ch15.html#41146
    
    * a genuine python applet using grail, a python based web browser <http://grail.sourceforge.net/>
      more doc: http://oreilly.com/catalog/python2/chapter/ch15.html#18563
    
    * a genuine java applet
    
    * a server side script that writes the data to this HTML file in <PARAM [...]> blocks
      plotted by the library JavaCharts <http://www.javatao.com/content/view/13/12/>

-->
<?xml version = "1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"DTD/xhtml1-strict.dtd">
<html xmlns = "http://www.w3.org/1999/xhtml">
  <head>
    <title>Realtime Temperature Display</title>
    <link href="flot/examples/layout.css" rel="stylesheet" type="text/css"></link>
    <!--[if IE]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="flot/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="flot/jquery.flot.js"></script>
    <script type="text/javascript" src="JavaSocketBridge/java_socket_bridge.js"></script>
    <script type="text/javascript">
      var firstTime = true;
      
      var avrnetio_address = '192.168.102.3';
      var avrnetio_port = 2701;
      
      var RN0=4700.0;
      var TN0 = 25.0+273.0;
      var B0 = 3548.0;
      var serial_resistance=10000.0;
      var Uvcc = 4.36;
      
      var rate = 5;   // 10 queries per second
      var displayedPoints = rate*4;  // we want the last 4 seconds to be displayed

      function ntc_resitance_to_temp(resistance) {
        var temperature = 1/(Math.log(resistance/RN0)/B0+1/TN0);
        return temperature;
      };    
      function calculate_resistance_of_ntc(Untc) {
        if (Untc <= 0) Untc=0.001;
        var ohm = serial_resistance / (( Uvcc / Untc ) - 1 );
        return ohm;
      };
      function ntc_potential_to_temp(potential) {
        return ntc_resitance_to_temp(calculate_resistance_of_ntc(potential));
      };
      
      
      var data = [[],[],[],[],[],[],[],[]];
      
	    function update_adc(){
	      if (java_socket_bridge_ready_flag == false) return;
	      if (firstTime) {
	        socket_connect(avrnetio_address, avrnetio_port);
	        firstTime = false;
        }
		    socket_send("adc get\n");
	    }
	    function on_socket_get(message){
		    document.getElementById('result').innerHTML = message;
		    
		    var split = message.split(" ");
	      for (var i = 0; i < split.length; i++) {
		      var value = parseInt(split[i], 16);
		      if (isNaN(value))
            continue;
          if (i==4){
            data[i].push([new Date().getTime(),ntc_potential_to_temp(value/1023.0*4.5)-273.0])
            if (data[i].length>displayedPoints) data[i].shift();
          }
	      }
		    
		    $.plot($("#placeholder"), data , { xaxis: { mode: "time" } });
	    }
	    window.onload=function(){
  	    setInterval('update_adc()', Math.round(1/rate*1000.0));
	    }

      $(function () {
          var d1 = [];
          for (var i = 0; i < 14; i += 0.5)
              d1.push([i, Math.sin(i)]);

          var d2 = [[0, 3], [4, 8], [8, 5], [9, 13]];

          // a null signifies separate line segments
          var d3 = [[0, 12], [7, 12], null, [7, 2.5], [12, 2.5]];
          xaxis: { mode: "time" }
          $.plot($("#placeholder"), [ d1, d2, d3 ], { xaxis: { mode: "time" } });
      });
    </script>

  </head>
  <body> 
    <h1>Temperature</h1>
    <hr>
	<div>
		<applet id="JavaSocketBridge" archive="JavaSocketBridge/JavaSocketBridge.jar" code="JavaSocketBridge.class" width="0" height="0">
		</applet>
	</div>

	<p id="result"></p>

    <div id="placeholder" style="width:1000px;height:600px;"></div>
    
</body>
</html>
